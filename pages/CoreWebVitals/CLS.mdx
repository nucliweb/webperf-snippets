import snippet from '../../snippets/CoreWebVitals/CLS.js?raw'
import { Snippet } from '../../components/Snippet'

# Cumulative Layout Shift (CLS)

### Overview

Quick check for [Cumulative Layout Shift](https://web.dev/articles/cls), a Core Web Vital that measures visual stability. CLS tracks how much the page layout shifts unexpectedly during its lifetime, providing a single score that represents the cumulative impact of all unexpected layout shifts.

**Why this matters:**

Unexpected layout shifts are frustrating and can cause users to click the wrong element or lose their reading position. CLS directly impacts user experience and is a ranking factor for Google Search. Common causes include images without dimensions, web fonts, and dynamically injected content.

**CLS Rating Thresholds:**

| Rating | Score | Meaning |
|--------|-------|---------|
| üü¢ Good | ‚â§ 0.1 | Stable, minimal shifting |
| üü° Needs Improvement | ‚â§ 0.25 | Noticeable shifting |
| üî¥ Poor | > 0.25 | Significant layout instability |

> **Need to debug?** Use [Layout Shift Tracking](/Interaction/Layout-Shift-Loading-and-Interaction) to identify which elements are causing shifts.

### Snippet

<Snippet code={snippet} />

### Understanding CLS

CLS measures the sum of all unexpected layout shifts that occur during the page's lifetime:

```
CLS = Œ£ (impact fraction √ó distance fraction)
```

- **Impact fraction**: How much of the viewport was affected
- **Distance fraction**: How far elements moved

**What's excluded:**
- Shifts within 500ms of user input (`hadRecentInput: true`)
- Shifts caused by scroll anchoring

**CLS Calculation Flow:**

```mermaid
flowchart TD
    Start[Layout Shift Detected] --> Recent{Within 500ms<br/>of user input?}

    Recent -->|Yes| Exclude[‚ùå Exclude from CLS<br/>hadRecentInput: true]
    Recent -->|No| Calculate[‚úÖ Include in CLS]

    Calculate --> Impact[Calculate Impact Fraction<br/>% of viewport affected]
    Impact --> Distance[Calculate Distance Fraction<br/>distance moved / viewport]
    Distance --> Score[Shift Score = Impact √ó Distance]
    Score --> Accumulate[Add to CLS total<br/>CLS += score]

    style Exclude fill:#FFE5E5
    style Calculate fill:#E5FFE5
    style Accumulate fill:#E5F2FF
```

**CLS Lifecycle:**

```mermaid
stateDiagram-v2
    [*] --> PageLoad: Navigation Start
    PageLoad --> Accumulating: First Shift
    Accumulating --> Accumulating: More Shifts<br/>(CLS += score)
    Accumulating --> Final: Page Hidden
    Final --> [*]

    note right of Accumulating
        Only shifts where<br/>hadRecentInput = false<br/>are counted
    end note
```

### Common Causes

| Cause | Solution |
|-------|----------|
| Images without dimensions | Add `width` and `height` attributes |
| Ads/embeds without space | Reserve space with CSS |
| Dynamic content injection | Reserve space or insert below fold |
| Web fonts (FOIT/FOUT) | Use `font-display: optional` or `size-adjust` |

### Further Reading

- [Cumulative Layout Shift (CLS)](https://web.dev/articles/cls) | web.dev
- [Optimize CLS](https://web.dev/articles/optimize-cls) | web.dev
- [Layout Shift Tracking](/Interaction/Layout-Shift-Loading-and-Interaction) | Detailed debugging snippet
